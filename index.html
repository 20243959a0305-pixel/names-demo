<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>儿童识字小报生成器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        input[type="text"],
        input[type="password"],
        select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .api-key-group {
            position: relative;
        }

        .api-key-group input {
            padding-right: 50px;
        }

        .toggle-visibility {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 14px;
        }

        .btn {
            width: 100%;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .scene-preview {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .scene-preview h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .word-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .word-tag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
        }

        .status-area {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-text {
            color: #666;
            font-size: 14px;
        }

        .result-area {
            text-align: center;
        }

        .result-image {
            max-width: 100%;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            margin-bottom: 20px;
        }

        .btn-download {
            background: #28a745;
            color: white;
            padding: 12px 30px;
            text-decoration: none;
            display: inline-block;
        }

        .btn-download:hover {
            background: #218838;
        }

        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            color: #c00;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .prompt-preview {
            background: #f0f0f0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
            color: #555;
            white-space: pre-wrap;
            display: none;
        }

        .prompt-toggle {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .hidden {
            display: none;
        }

        .options-row {
            display: flex;
            gap: 15px;
        }

        .options-row .form-group {
            flex: 1;
        }

        .help-text {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>儿童识字小报生成器</h1>
            <p class="subtitle">选择场景，输入标题，一键生成精美的识字小报</p>

            <!-- API Key 配置 -->
            <div class="form-group">
                <label>API Key</label>
                <div class="api-key-group">
                    <input type="password" id="apiKey" placeholder="请输入您的 kie.ai API Key">
                    <button class="toggle-visibility" onclick="toggleApiKeyVisibility()">显示</button>
                </div>
                <p class="help-text">从 <a href="https://kie.ai/api-key" target="_blank">kie.ai</a> 获取您的 API Key</p>
            </div>

            <!-- 场景选择 -->
            <div class="form-group">
                <label>选择场景</label>
                <select id="sceneSelect" onchange="updateScenePreview()">
                    <option value="">-- 请选择场景 --</option>
                </select>
                <div id="scenePreview" class="scene-preview hidden">
                    <h4>该场景包含的识字词汇：</h4>
                    <div id="wordTags" class="word-tags"></div>
                </div>
            </div>

            <!-- 标题输入 -->
            <div class="form-group">
                <label>小报标题</label>
                <input type="text" id="posterTitle" placeholder="例如：《走进超市》《快乐公园》">
            </div>

            <!-- 生成选项 -->
            <div class="options-row">
                <div class="form-group">
                    <label>图片比例</label>
                    <select id="aspectRatio">
                        <option value="3:4">3:4 (推荐A4竖版)</option>
                        <option value="9:16">9:16 (手机竖屏)</option>
                        <option value="4:3">4:3 (横版)</option>
                        <option value="1:1">1:1 (正方形)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>分辨率</label>
                    <select id="resolution">
                        <option value="1K">1K</option>
                        <option value="2K">2K (高清)</option>
                        <option value="4K">4K (超清)</option>
                    </select>
                </div>
            </div>

            <!-- 生成按钮 -->
            <button class="btn btn-primary" id="generateBtn" onclick="generatePoster()">
                生成识字小报
            </button>

            <!-- 查看提示词 -->
            <button class="prompt-toggle" onclick="togglePromptPreview()">查看生成的提示词</button>
            <pre id="promptPreview" class="prompt-preview"></pre>

            <!-- 状态显示 -->
            <div id="statusArea" class="status-area hidden">
                <div class="spinner"></div>
                <p class="status-text" id="statusText">正在生成中，请稍候...</p>
            </div>

            <!-- 错误显示 -->
            <div id="errorArea" class="error-message hidden"></div>
        </div>

        <!-- 结果展示 -->
        <div id="resultCard" class="card hidden">
            <div class="result-area">
                <h2 style="margin-bottom: 20px; color: #333;">生成完成！</h2>
                <img id="resultImage" class="result-image" src="" alt="生成的识字小报">
                <br>
                <a id="downloadBtn" class="btn btn-download" href="" download="识字小报.png">下载图片</a>
            </div>
        </div>
    </div>

    <script>
        // ==================== 场景词库 ====================
        const sceneLibrary = {
            supermarket: {
                name: "超市",
                defaultTitle: "走进超市",
                core: [
                    "shōu yín yuán 收银员",
                    "huò jià 货架",
                    "gòu wù chē 购物车",
                    "shōu yín tái 收银台"
                ],
                items: [
                    "píng guǒ 苹果",
                    "niú nǎi 牛奶",
                    "miàn bāo 面包",
                    "jī dàn 鸡蛋",
                    "shū cài 蔬菜",
                    "shuǐ guǒ 水果",
                    "bǐng gān 饼干",
                    "yǐn liào 饮料"
                ],
                environment: [
                    "chū kǒu 出口",
                    "rù kǒu 入口",
                    "jià gé biāo 价格标",
                    "gòu wù dài 购物袋"
                ]
            },
            hospital: {
                name: "医院",
                defaultTitle: "认识医院",
                core: [
                    "yī shēng 医生",
                    "hù shi 护士",
                    "bìng rén 病人",
                    "jiù hù chē 救护车"
                ],
                items: [
                    "tīng zhěn qì 听诊器",
                    "zhù shè qì 注射器",
                    "wēn dù jì 温度计",
                    "yào pǐn 药品",
                    "bēng dài 绷带",
                    "kǒu zhào 口罩",
                    "bái dà guà 白大褂",
                    "bìng chuáng 病床"
                ],
                environment: [
                    "guà hào chù 挂号处",
                    "yào fáng 药房",
                    "zhù yuàn bù 住院部",
                    "jí zhěn shì 急诊室"
                ]
            },
            park: {
                name: "公园",
                defaultTitle: "快乐公园",
                core: [
                    "huā duǒ 花朵",
                    "dà shù 大树",
                    "cǎo dì 草地",
                    "hú shuǐ 湖水"
                ],
                items: [
                    "qiū qiān 秋千",
                    "huá tī 滑梯",
                    "zhuǎn mǎ 转马",
                    "fēng zheng 风筝",
                    "zì xíng chē 自行车",
                    "pí qiú 皮球",
                    "chōng qì bǎo 充气堡",
                    "bǎng dèng 板凳"
                ],
                environment: [
                    "tíng zi 亭子",
                    "pēn quán 喷泉",
                    "xiǎo qiáo 小桥",
                    "lù dēng 路灯"
                ]
            },
            school: {
                name: "学校",
                defaultTitle: "我的学校",
                core: [
                    "lǎo shī 老师",
                    "xué shēng 学生",
                    "jiào shì 教室",
                    "cāo chǎng 操场"
                ],
                items: [
                    "shū běn 书本",
                    "qiān bǐ 铅笔",
                    "shū bāo 书包",
                    "hēi bǎn 黑板",
                    "zhuō zi 桌子",
                    "yǐ zi 椅子",
                    "fěn bǐ 粉笔",
                    "chǐ zi 尺子"
                ],
                environment: [
                    "tú shū guǎn 图书馆",
                    "shí táng 食堂",
                    "guó qí 国旗",
                    "xiào mén 校门"
                ]
            },
            kitchen: {
                name: "厨房",
                defaultTitle: "走进厨房",
                core: [
                    "chú shī 厨师",
                    "zào tái 灶台",
                    "bīng xiāng 冰箱",
                    "cān zhuō 餐桌"
                ],
                items: [
                    "guō 锅",
                    "wǎn 碗",
                    "pán zi 盘子",
                    "kuài zi 筷子",
                    "sháo zi 勺子",
                    "dāo 刀",
                    "zhēn bǎn 砧板",
                    "wēi bō lú 微波炉"
                ],
                environment: [
                    "chú guì 橱柜",
                    "shuǐ lóng tóu 水龙头",
                    "yóu yān jī 油烟机",
                    "chuāng hu 窗户"
                ]
            },
            zoo: {
                name: "动物园",
                defaultTitle: "动物园之旅",
                core: [
                    "dà xiàng 大象",
                    "shī zi 狮子",
                    "lǎo hǔ 老虎",
                    "cháng jǐng lù 长颈鹿"
                ],
                items: [
                    "hóu zi 猴子",
                    "xióng māo 熊猫",
                    "bān mǎ 斑马",
                    "hé mǎ 河马",
                    "è yú 鳄鱼",
                    "kǒng què 孔雀",
                    "xióng 熊",
                    "láng 狼"
                ],
                environment: [
                    "lóng zi 笼子",
                    "chí táng 池塘",
                    "shù lín 树林",
                    "mén piào 门票"
                ]
            },
            beach: {
                name: "海滩",
                defaultTitle: "快乐海滩",
                core: [
                    "dà hǎi 大海",
                    "shā tān 沙滩",
                    "hǎi làng 海浪",
                    "tài yáng 太阳"
                ],
                items: [
                    "yǒng yī 泳衣",
                    "yǒng jìng 泳镜",
                    "jiù shēng quān 救生圈",
                    "shā chǎn 沙铲",
                    "shā tǒng 沙桶",
                    "yáng sǎn 阳伞",
                    "bèi ké 贝壳",
                    "hǎi xīng 海星"
                ],
                environment: [
                    "dēng tǎ 灯塔",
                    "fān chuán 帆船",
                    "hǎi ōu 海鸥",
                    "yē zi shù 椰子树"
                ]
            },
            farm: {
                name: "农场",
                defaultTitle: "开心农场",
                core: [
                    "nóng mín 农民",
                    "nóng tián 农田",
                    "tuō lā jī 拖拉机",
                    "gǔ cāng 谷仓"
                ],
                items: [
                    "mǔ jī 母鸡",
                    "gōng jī 公鸡",
                    "xiǎo zhū 小猪",
                    "nǎi niú 奶牛",
                    "xiǎo yáng 小羊",
                    "yā zi 鸭子",
                    "tù zi 兔子",
                    "mǎ 马"
                ],
                environment: [
                    "zhà lán 栅栏",
                    "fēng chē 风车",
                    "shuǐ jǐng 水井",
                    "cǎo duī 草堆"
                ]
            },
            library: {
                name: "图书馆",
                defaultTitle: "安静的图书馆",
                core: [
                    "tú shū guǎn yuán 图书管理员",
                    "shū jià 书架",
                    "yuè lǎn shì 阅览室",
                    "jiè shū chù 借书处"
                ],
                items: [
                    "shū 书",
                    "zá zhì 杂志",
                    "bào zhǐ 报纸",
                    "diàn nǎo 电脑",
                    "jiè shū kǎ 借书卡",
                    "shū qiān 书签",
                    "bǐ jì běn 笔记本",
                    "cí diǎn 词典"
                ],
                environment: [
                    "tái dēng 台灯",
                    "shā fā 沙发",
                    "zì xí zhuō 自习桌",
                    "jìng yīn biāo 静音标"
                ]
            },
            restaurant: {
                name: "餐厅",
                defaultTitle: "美味餐厅",
                core: [
                    "fú wù yuán 服务员",
                    "chú shī 厨师",
                    "shōu yín tái 收银台",
                    "cài dān 菜单"
                ],
                items: [
                    "mǐ fàn 米饭",
                    "miàn tiáo 面条",
                    "jiǎo zi 饺子",
                    "tāng 汤",
                    "chá 茶",
                    "guǒ zhī 果汁",
                    "dàn gāo 蛋糕",
                    "bīng qí lín 冰淇淋"
                ],
                environment: [
                    "cān zhuō 餐桌",
                    "cān yǐ 餐椅",
                    "chuāng lián 窗帘",
                    "kōng tiáo 空调"
                ]
            }
        };

        // ==================== 初始化 ====================
        document.addEventListener('DOMContentLoaded', function() {
            // 加载保存的 API Key
            const savedApiKey = localStorage.getItem('kieApiKey');
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
            }

            // 填充场景选择
            const sceneSelect = document.getElementById('sceneSelect');
            for (const [key, scene] of Object.entries(sceneLibrary)) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = scene.name;
                sceneSelect.appendChild(option);
            }
        });

        // ==================== UI 交互 ====================
        function toggleApiKeyVisibility() {
            const input = document.getElementById('apiKey');
            const btn = event.target;
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = '隐藏';
            } else {
                input.type = 'password';
                btn.textContent = '显示';
            }
        }

        function updateScenePreview() {
            const sceneKey = document.getElementById('sceneSelect').value;
            const preview = document.getElementById('scenePreview');
            const wordTags = document.getElementById('wordTags');
            const titleInput = document.getElementById('posterTitle');

            if (!sceneKey) {
                preview.classList.add('hidden');
                return;
            }

            const scene = sceneLibrary[sceneKey];

            // 更新默认标题
            if (!titleInput.value) {
                titleInput.value = `《${scene.defaultTitle}》`;
            }

            // 显示词汇标签
            const allWords = [...scene.core, ...scene.items, ...scene.environment];
            wordTags.innerHTML = allWords.map(word => {
                const hanzi = word.split(' ').pop();
                return `<span class="word-tag">${hanzi}</span>`;
            }).join('');

            preview.classList.remove('hidden');
        }

        function togglePromptPreview() {
            const preview = document.getElementById('promptPreview');
            if (preview.style.display === 'block') {
                preview.style.display = 'none';
            } else {
                preview.style.display = 'block';
            }
        }

        // ==================== 提示词生成 ====================
        function generatePrompt(sceneKey, title) {
            const scene = sceneLibrary[sceneKey];

            const prompt = `请生成一张儿童识字小报《${scene.name}》，竖版 A4，学习小报版式，适合 5-9 岁孩子认字与看图识物。

# 一、小报标题区(顶部)
**顶部居中大标题**：${title}
**风格**：儿童小报/儿童学习报感
**文本要求**：大字、醒目、卡通手写体、彩色描边
**装饰**：周围添加与${scene.name}相关的贴纸风装饰，颜色鲜艳

# 二、小报主体(中间主画面)
画面中心是一幅**卡通插画风的「${scene.name}」场景**：
**整体气氛**：明亮、温暖、积极
**构图**：物体边界清晰，方便对应文字，不要过于拥挤

**场景分区与核心内容**
1. **核心区域 A(主要对象)**：表现${scene.name}的核心活动
2. **核心区域 B(配套设施)**：展示相关的工具或物品
3. **核心区域 C(环境背景)**：体现环境特征(如墙面、指示牌等)

**主题人物**
**角色**：1 位可爱卡通人物(职业/身份与${scene.name}匹配)
**动作**：正在进行与场景相关的自然互动

# 三、必画物体与识字清单
**请务必在画面中清晰绘制以下物体，并为其预留贴标签的位置：**

**1. 核心角色与设施：**
${scene.core.join('，')}

**2. 常见物品/工具：**
${scene.items.join('，')}

**3. 环境与装饰：**
${scene.environment.join('，')}

# 四、识字标注规则
对上述清单中的物体，贴上中文识字标签：
**格式**：两行制(第一行拼音带声调，第二行简体汉字)
**样式**：彩色小贴纸风格，白底黑字或深色字，清晰可读
**排版**：标签靠近对应的物体，不遮挡主体

# 五、画风参数
**风格**：儿童绘本风+识字小报风
**色彩**：高饱和、明快、温暖(High Saturation，Warm Tone)
**质量**：8k resolution, high detail, vector illustration style, clean lines`;

            return prompt;
        }

        // ==================== API 调用 ====================
        async function createTask(apiKey, prompt, aspectRatio, resolution) {
            const response = await fetch('https://api.kie.ai/api/v1/jobs/createTask', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'nano-banana-pro',
                    input: {
                        prompt: prompt,
                        image_input: [],
                        aspect_ratio: aspectRatio,
                        resolution: resolution,
                        output_format: 'png'
                    }
                })
            });

            const data = await response.json();

            if (data.code !== 200) {
                throw new Error(data.msg || '创建任务失败');
            }

            return data.data.taskId;
        }

        async function queryTask(apiKey, taskId) {
            const response = await fetch(`https://api.kie.ai/api/v1/jobs/recordInfo?taskId=${taskId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${apiKey}`
                }
            });

            const data = await response.json();

            if (data.code !== 200) {
                throw new Error(data.msg || '查询任务失败');
            }

            return data.data;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ==================== 主流程 ====================
        async function generatePoster() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const sceneKey = document.getElementById('sceneSelect').value;
            const title = document.getElementById('posterTitle').value.trim();
            const aspectRatio = document.getElementById('aspectRatio').value;
            const resolution = document.getElementById('resolution').value;

            // 验证输入
            if (!apiKey) {
                showError('请输入 API Key');
                return;
            }
            if (!sceneKey) {
                showError('请选择场景');
                return;
            }
            if (!title) {
                showError('请输入小报标题');
                return;
            }

            // 保存 API Key
            localStorage.setItem('kieApiKey', apiKey);

            // 生成提示词
            const prompt = generatePrompt(sceneKey, title);
            document.getElementById('promptPreview').textContent = prompt;

            // 显示加载状态
            const btn = document.getElementById('generateBtn');
            const statusArea = document.getElementById('statusArea');
            const resultCard = document.getElementById('resultCard');
            const errorArea = document.getElementById('errorArea');

            btn.disabled = true;
            btn.textContent = '生成中...';
            statusArea.classList.remove('hidden');
            resultCard.classList.add('hidden');
            errorArea.classList.add('hidden');

            try {
                // 创建任务
                updateStatus('正在创建生成任务...');
                const taskId = await createTask(apiKey, prompt, aspectRatio, resolution);

                // 轮询任务状态
                updateStatus('任务已创建，正在生成图片...');
                let attempts = 0;
                const maxAttempts = 60; // 最多等待 3 分钟

                while (attempts < maxAttempts) {
                    await sleep(3000); // 每 3 秒查询一次

                    const taskInfo = await queryTask(apiKey, taskId);

                    if (taskInfo.state === 'success') {
                        // 成功
                        const result = JSON.parse(taskInfo.resultJson);
                        const imageUrl = result.resultUrls[0];

                        showResult(imageUrl);
                        return;
                    } else if (taskInfo.state === 'fail') {
                        // 失败
                        throw new Error(taskInfo.failMsg || '生成失败');
                    }

                    // 继续等待
                    attempts++;
                    updateStatus(`正在生成中，请耐心等待... (${attempts * 3}秒)`);
                }

                throw new Error('生成超时，请稍后重试');

            } catch (error) {
                showError(error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '生成识字小报';
                statusArea.classList.add('hidden');
            }
        }

        function updateStatus(text) {
            document.getElementById('statusText').textContent = text;
        }

        function showError(message) {
            const errorArea = document.getElementById('errorArea');
            errorArea.textContent = '错误：' + message;
            errorArea.classList.remove('hidden');
        }

        function showResult(imageUrl) {
            const resultCard = document.getElementById('resultCard');
            const resultImage = document.getElementById('resultImage');
            const downloadBtn = document.getElementById('downloadBtn');

            resultImage.src = imageUrl;
            downloadBtn.href = imageUrl;
            resultCard.classList.remove('hidden');

            // 滚动到结果
            resultCard.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
